<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<style>
    .fieldError {
        border-color: #bd2130;
    }
</style>
<head>
    <meta charset="utf-8">
    <h1>LoveLove</h1>
    <h2 th:text="|${member}님 주위의 이성|"></h2>

</head>
<body>
<div id="map" style="width:800px;height:600px;">
    <script th:inline="javascript" src="http://code.jquery.com/jquery-latest.js"></script>
    <script th:inline="javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e555062ab88e1ebe1463187ab4a9bcb9&libraries=services,cluster"></script>
</div>
</body>
<script th:inline="javascript">

    navigator.geolocation.watchPosition(function (position) {

        var lat = position.coords.latitude;
        var lon = position.coords.longitude;
        var locPosition = new kakao.maps.LatLng(lat, lon);


        var mapOption = {

            center: locPosition, // 지도의 중심좌표
            level: 3, // 지도의 확대 레벨
            mapTypeId: kakao.maps.MapTypeId.ROADMAP // 지도종류
        };
        // 지도를 생성한다

        var map = new kakao.maps.Map(mapContainer, mapOption);
        var imageSrc = "/images/heart.svg"
        var imageSize = new kakao.maps.Size(24, 35);
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

        // 마커를 생성합니다
        var geocoder = new kakao.maps.services.Geocoder();


        var callback = function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                console.log(result);
                console.log(location);
                getJson();
                // return geocoder[0].code;

            } else (console.log(result, status))

        };

        geocoder.coord2RegionCode(lon, lat, callback);

        let jsonData = {
            'lat': lat,
            'lon': lon,
        };
        // 주변 이성 DB 탐색
        function getJson() {
            $.ajax({
                type: "post",
                url: "/love/main",
                dataType : "json",
                // headers : {'Authorization':'KakaoAK {e555062ab88e1ebe1463187ab4a9bcb9}'},
                data: jsonData,
                success: function (d) {
                    // var data = JSON.parse.d;
                    console.log(d, typeof (d))
                    var positionList = new Array();
                    var contents = new Array();
                    var intro = new Array();
                    var nickname = new Array();
                    var img = new Array();

                    for (var i = 0; i < d.name.length; i++) {
                        positionList.push(new kakao.maps.LatLng(d.Clat[i], d.Clon[i]));
                        contents.push(d.name[i]);
                        img.push(d.images[i]);
                        intro.push(d.introduce[i]);
                        nickname.push(d.nickname[i]);
                    }


                    //controller 에서 받아온 find list 를 맵에 추가
                    positionList.forEach(function (pos) {
                        console.log(pos);
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: pos,
                            image: markerImage,
                            clickable: true,

                        });

                        var customOverlay = new kakao.maps.CustomOverlay({
                            position: pos,
                            clickable: true,
                        })


                        // HTMLElement 구성
                        //
                        //
                        var placeContent = document.createElement("div")
                        placeContent.className = "place-content"

                        var placeHead = document.createElement("div")
                        placeHead.className = "place-head"
                        var placeBody = document.createElement("div")
                        placeBody.className = "place-body"

                        var placeName = document.createElement("div");
                        placeName.innerHTML = pos.contents;
                        var placeImg = document.createElement("img");
                        // placeImg.setAttribute("src", img[i]);
                        var placeIntro = document.createElement("div");
                        placeIntro.innerHTML = "소개 : " + intro;
                        var placeNickname = document.createElement("div");
                        placeNickname.innerHTML = nickname;
                        var placeMessage = document.createElement("a");
                        placeMessage.innerHTML = "메세지 전송";
                        placeMessage.className = "place-message";
                        placeMessage.addEventListener("click", () =>
                            function () {
                                document.querySelector(".modal").classList.remove("hidden");
                            }
                        );
                        var placeDislike = document.createElement("a");
                        placeDislike.innerHTML = "나가기";
                        placeDislike.className = "place-dislike";
                        placeDislike.onclick = closeOverlay();

                        placeContent.append(placeHead, placeBody)
                        placeHead.append(placeName, placeImg)
                        placeBody.append(
                            placeIntro,
                            placeNickname,
                            placeMessage,
                            placeDislike,
                        )
                        customOverlay.setContent(placeContent);

                        console.log(positionList);
                        console.log(contents);
                        console.log(intro);
                        console.log(nickname);


                        // kakao.maps.event.addListener(marker, 'click', function () {
                        //     customOverlay.setMap(map);
                        // });
                        kakao.maps.event.addListener(marker, "click", () => {
                            if (this.clickedOveray) {
                                this.clickedOveray.setMap(null)
                            }
                            customOverlay.setMap(map)
                            this.clickedOveray = customOverlay
                        })
                        kakao.maps.event.addListener(map, "click", function () {
                            customOverlay.setMap(null)
                        });

                        function closeOverlay() {
                            customOverlay.setMap(null);
                        }
                    });


                          // kakao.maps.event.addListener(maker, 'click', makeClickOverlayListner(map, marker, customOverlay));




                    // function makeClickOverlayListner(map, marker, customOverlay) {
                    //     return function () {
                    //         customOverlay.open(map, marker);
                    //     };
                    //
                    // }

                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            }).done(function (data) {
            });
        }

    });

    var mapContainer = document.getElementById('map'); // 지도를 표시할 div


    var options = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
    };
</script>
</html>

